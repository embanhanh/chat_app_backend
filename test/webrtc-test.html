<!DOCTYPE html>
<html lang="vi">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>Test WebRTC Video Call</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .auth-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .auth-form {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        video {
            width: 400px;
            height: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 200px;
            background-color: white;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:disabled {
            background-color: #ccc;
        }
        button.end-call {
            background-color: #dc3545;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        #targetUserId {
            padding: 8px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .accept-call {
            background-color: #28a745 !important;
        }
        .reject-call {
            background-color: #dc3545 !important;
        }
        .calling-status {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test WebRTC Video Call</h1>
        
        <div class="auth-container">
            <!-- Form đăng nhập -->
            <div class="auth-form" id="loginForm">
                <h2>Đăng nhập</h2>
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button onclick="login()">Đăng nhập</button>
            </div>

            <!-- Form đăng ký -->
            <div class="auth-form" id="registerForm">
                <h2>Đăng ký</h2>
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" required>
                </div>
                <button onclick="register()">Đăng ký</button>
            </div>
        </div>

        <div class="call-section" style="display: none;">
            <div class="status" id="connectionStatus">Chưa kết nối</div>
            
            <div class="video-container">
                <div>
                    <h3>Local Video</h3>
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                <div>
                    <h3>Remote Videos</h3>
                    <div id="remoteVideos"></div>
                </div>
            </div>

            <div class="controls" id="callControls">
                <select id="conversationSelect">
                    <option value="">Chọn cuộc trò chuyện</option>
                </select>
                <button onclick="startCall()">Gọi</button>
                <button onclick="endCall()" class="end-call">Kết thúc</button>
                <button onclick="toggleAudio()" id="audioBtn">Tắt mic</button>
                <button onclick="toggleVideo()" id="videoBtn">Tắt camera</button>
                <button onclick="logout()" class="end-call">Đăng xuất</button>
            </div>

            <div class="controls" id="inCallControls" style="display: none;">
                <button onclick="endCall()" class="end-call">Kết thúc</button>
                <button onclick="toggleAudio()" id="audioBtn">Tắt mic</button>
                <button onclick="toggleVideo()" id="videoBtn">Tắt camera</button>
            </div>
        </div>
    </div>

    <div id="incomingCallModal" class="modal">
        <div class="modal-content">
            <h2>Cuộc gọi đến</h2>
            <p id="callerInfo">Đang có cuộc gọi từ: <span id="callerName"></span></p>
            <div class="modal-buttons">
                <button onclick="acceptCall()" class="accept-call">Chấp nhận</button>
                <button onclick="rejectCall()" class="reject-call">Từ chối</button>
            </div>
        </div>
    </div>

    <div id="callingStatus" class="calling-status">
        Đang gọi...
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let socket;
        let localStream;
        let peerConnections = new Map();
        let currentCall = null;
        let currentUser = null;
        let incomingCallData = null;

        // Gọi checkAuth khi trang load
        document.addEventListener('DOMContentLoaded', checkAuth);

        const configuration = {
            iceServers: [
                {
                    urls: [
                        'stun:stun.l.google.com:19302',
                        'stun:stun1.l.google.com:19302'
                    ]
                }
            ]
        };

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await axios.post('/api/login', { username, password });
                const data = response.data;
                currentUser = data.user;
                
                // Lưu thông tin vào localStorage
                localStorage.setItem('auth', JSON.stringify({
                    user: data.user,
                    token: data.token,
                    lastLogin: new Date().toISOString()
                }));
                
                // Kết nối WebSocket với token
                connectSocket(data.token);

                // Ẩn form đăng nhập/đăng ký
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.call-section').style.display = 'block';

                updateStatus(`Đã đăng nhập: ${currentUser.username}`);
            } catch (error) {
                alert(error.response?.data?.message || 'Lỗi đăng nhập');
            }
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            try {
                const response = await axios.post('/api/register', { username, email, password });
                const data = response.data;
                currentUser = data.user;
                
                // Kết nối WebSocket với token
                connectSocket(data.token);

                // Ẩn form đăng nhập/đăng ký
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.call-section').style.display = 'block';

                updateStatus(`Đã đăng ký và đăng nhập: ${currentUser.username}`);
            } catch (error) {
                alert(error.response?.data?.message || 'Lỗi đăng ký');
            }
        }

        function logout() {
            if (socket) {
                socket.disconnect();
            }
            currentUser = null;
            // Xóa thông tin đăng nhập khỏi localStorage
            localStorage.removeItem('auth');
            cleanup();

            // Hiển thị lại form đăng nhập/đăng ký
            document.querySelector('.auth-container').style.display = 'flex';
            document.querySelector('.call-section').style.display = 'none';

            // Reset các form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('regUsername').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
        }

        function connectSocket(token) {
            // Kết nối tới WebSocket server với token
            socket = io('http://localhost:60804', {
                query: {
                    token: token
                }
            });

            setupSocketListeners();
            setupLocalStream();
            loadConversations();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                console.log('✅ Socket connected successfully', {
                    socketId: socket.id,
                    userId: currentUser?._id,
                    username: currentUser?.username
                });
                updateStatus('Đã kết nối tới server');
            });

            socket.on('disconnect', () => {
                console.log('❌ Socket disconnected');
                updateStatus('Mất kết nối tới server');
                cleanup();
            });

            socket.on('connect_error', (error) => {
                console.error('❌ Socket connection error:', error);
                updateStatus('Lỗi kết nối: ' + error.message);
            });

            socket.on('incoming_call', async (data) => {
                try {
                    console.log('📞 Incoming call received:', {
                        from: data.from,
                        fromUsername: data.fromUsername,
                        type: data.type,
                        timestamp: new Date().toISOString()
                    });
                    
                    if (!data || !data.from || !data.fromUsername) {
                        throw new Error('Dữ liệu cuộc gọi không hợp lệ');
                    }

                    // Kiểm tra xem có đang trong cuộc gọi khác không
                    if (currentCall) {
                        console.log('❌ Reject call - Already in another call', {
                            currentCall,
                            newCall: data.from
                        });
                        socket.emit('call_response', {
                            targetUserId: data.from,
                            accepted: false,
                            reason: 'busy'
                        });
                        return;
                    }

                    // Yêu cầu quyền thông báo nếu chưa có
                    if (Notification.permission !== 'granted') {
                        await Notification.requestPermission();
                    }

                    // Hiển thị thông báo desktop
                    if (Notification.permission === 'granted') {
                        const notification = new Notification('Cuộc gọi đến', {
                            body: `${data.fromUsername} đang gọi cho bạn`,
                            requireInteraction: true
                        });
                        
                        notification.onclick = function() {
                            window.focus();
                            this.close();
                        };
                    }

                    // Lưu thông tin cuộc gọi đến
                    incomingCallData = data;
                    
                    // Hiển thị modal và phát âm báo
                    showIncomingCall(data);
                    
                    // Tự động từ chối sau 30 giây nếu không phản hồi
                    setTimeout(() => {
                        if (incomingCallData && incomingCallData.from === data.from) {
                            console.log('⏰ Auto rejecting call after timeout', {
                                from: data.from,
                                timestamp: new Date().toISOString()
                            });
                            rejectCall('timeout');
                        }
                    }, 30000);

                } catch (error) {
                    console.error('❌ Error handling incoming call:', error);
                    if (data && data.from) {
                        socket.emit('call_response', {
                            targetUserId: data.from,
                            accepted: false,
                            reason: 'error'
                        });
                    }
                }
            });

            socket.on('call_accepted', async (data) => {
                try {
                    console.log('✅ Call accepted:', {
                        from: data.from,
                        username: data.username,
                        timestamp: new Date().toISOString()
                    });
                    hideCallingStatus();
                    updateStatus('Cuộc gọi được chấp nhận');

                    // Người gọi (caller) tạo peer connection và gửi offer
                    const peerConnection = new RTCPeerConnection(configuration);
                    peerConnections.set(data.from, peerConnection);

                    // Thêm local stream
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    // Xử lý ICE candidate
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log('📤 Sending ICE candidate to:', data.from);
                            socket.emit('ice_candidate', {
                                candidate: event.candidate,
                                targetUserId: data.from
                            });
                        }
                    };

                    // Xử lý remote stream
                    peerConnection.ontrack = (event) => {
                        console.log('📥 Received remote track from:', data.from);
                        updateRemoteVideo(data.from, event.streams[0]);
                    };

                    // Tạo và gửi offer
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    console.log('📤 Sending offer to:', data.from);
                    socket.emit('offer', {
                        offer,
                        targetUserId: data.from,
                        from: socket.userId
                    });

                    currentCall = {
                        userId: data.from,
                        type: 'outgoing'
                    };
                } catch (error) {
                    console.error('❌ Error in call_accepted:', error);
                    updateStatus('Lỗi khi thiết lập cuộc gọi');
                }
            });

            socket.on('call_rejected', (data) => {
                console.log('❌ Call rejected:', {
                    from: data.from,
                    reason: data.reason,
                    timestamp: new Date().toISOString()
                });
                hideCallingStatus();
                let message = 'Cuộc gọi bị từ chối';
                
                // Thêm lý do từ chối nếu có
                if (data.reason) {
                    switch(data.reason) {
                        case 'busy':
                            message += ': Người dùng đang bận';
                            break;
                        case 'timeout':
                            message += ': Không có phản hồi';
                            break;
                        case 'error':
                            message += ': Lỗi kết nối';
                            break;
                        default:
                            message += ': ' + data.reason;
                    }
                }
                
                updateStatus(message);
                cleanup();
            });

            socket.on('call_error', (error) => {
                console.error('❌ Call error:', error);
                updateStatus('Lỗi cuộc gọi: ' + error.message);
            });

            async function waitForRemoteDescription(peerConnection) {
                return new Promise((resolve) => {
                    if (peerConnection.remoteDescription) {
                        resolve();
                        return;
                    }
                    const checkInterval = setInterval(() => {
                        if (peerConnection.remoteDescription) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 100);
                });
            }

            socket.on('ice_candidate', async (data) => {
                try {
                    const peerConnection = peerConnections.get(data.from);
                    if (!peerConnection) {
                        console.error('❌ No peer connection found for user:', data.from);
                        return;
                    }

                    // Nếu chưa có remote description, cache candidate
                    if (!peerConnection.remoteDescription) {
                        console.log('⏳ Caching ICE candidate - No remote description yet');
                        if (!peerConnection.cachedCandidates) {
                            peerConnection.cachedCandidates = [];
                        }
                        peerConnection.cachedCandidates.push(data.candidate);
                        return;
                    }

                    // Thêm candidate nếu trạng thái cho phép
                    if (data.candidate && ['stable', 'have-remote-offer', 'have-local-offer'].includes(peerConnection.signalingState)) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                        console.log('✅ ICE candidate added successfully');
                    }
                } catch (error) {
                    console.error('❌ Error handling ICE candidate:', error);
                }
            });

            socket.on('offer', async (data) => {
                try {
                    console.log('📨 Received offer from:', data.from);
                    
                    // Người nhận (callee) tạo peer connection để trả lời
                    const peerConnection = new RTCPeerConnection(configuration);
                    peerConnections.set(data.from, peerConnection);

                    // Thêm local stream
                    localStream.getTracks().forEach(track => {
                        peerConnection.addTrack(track, localStream);
                    });

                    // Xử lý ICE candidate
                    peerConnection.onicecandidate = (event) => {
                        if (event.candidate) {
                            console.log('📤 Sending ICE candidate to:', data.from);
                            socket.emit('ice_candidate', {
                                candidate: event.candidate,
                                targetUserId: data.from
                            });
                        }
                    };

                    // Xử lý remote stream
                    peerConnection.ontrack = (event) => {
                        console.log('📥 Received remote track from:', data.from);
                        updateRemoteVideo(data.from, event.streams[0]);
                    };

                    // Thiết lập remote description từ offer nhận được
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));

                    // Tạo và gửi answer
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    console.log('📤 Sending answer to:', data.from);
                    socket.emit('answer', {
                        answer,
                        targetUserId: data.from,
                        from: socket.userId
                    });

                    currentCall = {
                        userId: data.from,
                        type: 'incoming'
                    };
                } catch (error) {
                    console.error('❌ Error handling offer:', error);
                    socket.emit('call_error', {
                        message: 'Lỗi xử lý offer: ' + error.message
                    });
                }
            });

            socket.on('answer', async (data) => {
                try {
                    console.log('📨 Received answer from:', data.from);
                    const peerConnection = peerConnections.get(data.from);
                    
                    if (!peerConnection) {
                        throw new Error('No peer connection found for user: ' + data.from);
                    }

                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    console.log('✅ Remote description set successfully');

                    // Thêm các ICE candidate đã cache (nếu có)
                    if (peerConnection.cachedCandidates?.length > 0) {
                        console.log('📤 Adding cached ICE candidates');
                        for (const candidate of peerConnection.cachedCandidates) {
                            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        }
                        peerConnection.cachedCandidates = [];
                    }
                } catch (error) {
                    console.error('❌ Error handling answer:', error);
                }
            });

            socket.on('call_ended', () => {
                console.log('📞 Call ended');
                hideCallingStatus();
                hideIncomingCall();
                updateStatus('Cuộc gọi kết thúc');
                cleanup();
            });
        }

        async function setupLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (error) {
                console.error('Error accessing media devices:', error);
                updateStatus('Lỗi truy cập camera/mic');
            }
        }

        async function setupPeerConnection(targetUserId, isInitiator) {
            const peerConnection = new RTCPeerConnection(configuration);
            console.log('setupPeerConnection targetUserId:', targetUserId, 'isInitiator:', isInitiator);
            
            // Lưu kết nối
            peerConnections.set(targetUserId, peerConnection);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice_candidate', {
                        candidate: event.candidate,
                        targetUserId
                    });
                }
            };

            peerConnection.ontrack = (event) => {
                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = event.streams[0];
                remoteVideo.autoplay = true;
                remoteVideo.playsInline = true;
                remoteVideo.className = 'remote-video';
                remoteVideo.id = `remote-video-${targetUserId}`;
                document.getElementById('remoteVideos').appendChild(remoteVideo);
            };

            if (isInitiator) {
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('offer', {
                        offer,
                        targetUserId,
                        from: socket.userId
                    });
                } catch (error) {
                    console.error('Error creating offer:', error);
                }
            }

            currentCall = targetUserId;
        }

        async function startCall() {
            try {
                const conversationId = document.getElementById('conversationSelect').value;
                if (!conversationId) {
                    alert('Vui lòng chọn cuộc trò chuyện');
                    return;
                }

                // Gửi yêu cầu gọi đến server
                socket.emit('call_user', {
                    conversationId,
                    type: 'video' // Mặc định là video call
                });

                // Hiển thị UI cuộc gọi
                document.getElementById('callControls').style.display = 'none';
                document.getElementById('inCallControls').style.display = 'block';
                
                // Bắt đầu phát nhạc chuông
                playRingtone();
                
            } catch (error) {
                console.error('Lỗi khi bắt đầu cuộc gọi:', error);
                alert('Không thể bắt đầu cuộc gọi: ' + error.message);
            }
        }

        function endCall() {
            try {
                console.log('📞 Ending call');
                
                // Gửi tín hiệu kết thúc cuộc gọi đến server
                if (currentCall?.userId) {
                    socket.emit('end_call', {
                        targetUserId: currentCall.userId
                    });
                }

                // Dọn dẹp
                cleanup();
                
                console.log('✅ Call ended successfully');
            } catch (error) {
                console.error('❌ Error ending call:', error);
            }
        }

        function cleanup() {
            try {
                console.log('🧹 Cleaning up call resources');
                
                // Dọn dẹp các kết nối peer
                peerConnections.forEach((peerConnection, userId) => {
                    console.log(`Closing peer connection for user: ${userId}`);
                    peerConnection.close();
                    peerConnections.delete(userId);
                });

                // Xóa tất cả remote videos
                const remoteVideosContainer = document.getElementById('remoteVideos');
                while (remoteVideosContainer.firstChild) {
                    remoteVideosContainer.removeChild(remoteVideosContainer.firstChild);
                }

                // Reset các biến
                currentCall = null;
                incomingCallData = null;

                // Reset UI
                document.getElementById('callControls').style.display = 'block';
                document.getElementById('inCallControls').style.display = 'none';
                hideCallingStatus();
                hideIncomingCall();
                stopRingtone();

                console.log('✅ Cleanup completed');
            } catch (error) {
                console.error('❌ Error during cleanup:', error);
            }
        }

        // Thêm hàm để quản lý video elements
        function updateRemoteVideo(userId, stream) {
            try {
                console.log(`Updating remote video for user: ${userId}`);
                
                // Xóa video cũ nếu có
                const existingVideo = document.getElementById(`remote-video-${userId}`);
                if (existingVideo) {
                    existingVideo.remove();
                }

                // Tạo video mới
                const remoteVideo = document.createElement('video');
                remoteVideo.srcObject = stream;
                remoteVideo.autoplay = true;
                remoteVideo.playsInline = true;
                remoteVideo.className = 'remote-video';
                remoteVideo.id = `remote-video-${userId}`;
                document.getElementById('remoteVideos').appendChild(remoteVideo);

                console.log('✅ Remote video updated successfully');
            } catch (error) {
                console.error('❌ Error updating remote video:', error);
            }
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('audioBtn').textContent = 
                    audioTrack.enabled ? 'Tắt mic' : 'Bật mic';
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('videoBtn').textContent = 
                    videoTrack.enabled ? 'Tắt camera' : 'Bật camera';
            }
        }

        function updateStatus(message) {
            document.getElementById('connectionStatus').textContent = message;
        }

        function showIncomingCall(data) {
            try {
                console.log('📱 Showing incoming call UI:', data);
                incomingCallData = data; // Lưu data ngay khi hiển thị
                const callerName = document.getElementById('callerName');
                callerName.textContent = data.fromUsername || data.from;
                const modal = document.getElementById('incomingCallModal');
                modal.style.display = 'block';
                playRingtone();
            } catch (error) {
                console.error('❌ Error showing incoming call:', error);
            }
        }

        function hideIncomingCall() {
            try {
                const modal = document.getElementById('incomingCallModal');
                modal.style.display = 'none';
                stopRingtone();
                // KHÔNG xóa incomingCallData ở đây vì còn cần dùng cho việc thiết lập kết nối
            } catch (error) {
                console.error('❌ Error hiding incoming call:', error);
            }
        }

        function showCallingStatus() {
            const status = document.getElementById('callingStatus');
            status.style.display = 'block';
        }

        function hideCallingStatus() {
            const status = document.getElementById('callingStatus');
            status.style.display = 'none';
        }

        async function acceptCall() {
            try {
                console.log('Accepting call with data:', incomingCallData);
                
                if (!incomingCallData) {
                    console.error('❌ No incoming call data available');
                    updateStatus('Lỗi: Không có thông tin cuộc gọi');
                    return;
                }
                
                hideIncomingCall();
                updateStatus('Đang kết nối cuộc gọi...');
                
                // Gửi phản hồi chấp nhận cuộc gọi
                console.log('📤 Sending call_response:', {
                    targetUserId: incomingCallData.from,
                    accepted: true,
                    timestamp: new Date().toISOString()
                });
                
                socket.emit('call_response', {
                    targetUserId: incomingCallData.from,
                    accepted: true
                });
                
                // KHÔNG tạo peer connection ở đây
                // Chờ nhận offer từ người gọi
                
            } catch (error) {
                console.error('❌ Error in acceptCall:', error);
                updateStatus('Lỗi khi chấp nhận cuộc gọi');
            }
        }

        function rejectCall(reason = 'rejected') {
            try {
                console.log('Rejecting call:', {
                    incomingCallData,
                    reason,
                    timestamp: new Date().toISOString()
                });
                
                if (!incomingCallData) {
                    console.error('❌ No incoming call data available');
                    return;
                }
                
                socket.emit('call_response', {
                    targetUserId: incomingCallData.from,
                    accepted: false,
                    reason: reason
                });
                
                hideIncomingCall();
                updateStatus('Đã từ chối cuộc gọi');
                cleanup();
            } catch (error) {
                console.error('❌ Error in rejectCall:', error);
            }
        }

        // Thêm âm thanh thông báo
        let ringtone;
        function playRingtone() {
            ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/2912/2912-preview.mp3');
            ringtone.loop = true;
            ringtone.play().catch(e => console.log('Không thể phát nhạc chuông:', e));
        }

        function stopRingtone() {
            if (ringtone) {
                ringtone.pause();
                ringtone.currentTime = 0;
            }
        }

        // Thêm hàm kiểm tra đăng nhập khi load trang
        function checkAuth() {
            const auth = localStorage.getItem('auth');
            if (auth) {
                const { user, token } = JSON.parse(auth);
                currentUser = user;
                connectSocket(token);
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.call-section').style.display = 'block';
                updateStatus(`Đã đăng nhập: ${currentUser.username}`);
            }
        }

        // Thêm hàm load conversations
        async function loadConversations() {
            try {
                const auth = localStorage.getItem('auth');
                if (!auth) {
                    throw new Error('Chưa đăng nhập');
                }

                const { token } = JSON.parse(auth);
                const response = await axios.get('http://localhost:60804/api/conversations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = response.data;
                console.log('Danh sách conversations:', data.conversations);
                
                const select = document.getElementById('conversationSelect');
                if (!select) {
                    console.error('Không tìm thấy element conversationSelect');
                    return;
                }
                
                // Xóa các option cũ
                select.innerHTML = '<option value="">Chọn cuộc trò chuyện</option>';
                
                // Thêm các option mới
                if (data.conversations && Array.isArray(data.conversations)) {
                    data.conversations.forEach(conv => {
                        if (!conv || !conv.conversationId) return; // Sửa từ _id thành conversationId
                        
                        const option = document.createElement('option');
                        option.value = conv.conversationId; // Sửa từ _id thành conversationId
                        
                        // Kiểm tra và xử lý tên hiển thị
                        let displayName = '';
                        if (conv.type === 'private') {
                            // Với private chat, hiển thị tên người dùng khác
                            displayName = conv.conversationId || 'Chat riêng';
                        } else {
                            // Với group chat, hiển thị tên nhóm và số thành viên
                            displayName = conv.name ? 
                                `Nhóm: ${conv.name} (${conv.participants?.length || 0} thành viên)` : 
                                `Nhóm chat (${conv.participants?.length || 0} thành viên)`;
                        }
                        
                        option.textContent = displayName;
                        select.appendChild(option);
                    });

                    // Log số lượng options đã thêm
                    console.log(`Đã thêm ${select.options.length - 1} cuộc trò chuyện vào combobox`);
                } else {
                    console.warn('Không có dữ liệu conversations hoặc định dạng không đúng');
                }

                // Kiểm tra và log trạng thái của select
                console.log('Trạng thái combobox:', {
                    visible: select.offsetParent !== null,
                    width: select.offsetWidth,
                    height: select.offsetHeight,
                    options: select.options.length
                });
            } catch (error) {
                console.error('Lỗi tải conversations:', error);
                alert(error.response?.data?.message || error.message);
            }
        }
    </script>
</body>
</html> 