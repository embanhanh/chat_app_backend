<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Test WebRTC Video Call</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .auth-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .auth-form {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        video {
            width: 400px;
            height: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
        }
        button:disabled {
            background-color: #ccc;
        }
        button.end-call {
            background-color: #dc3545;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        #targetUserId {
            padding: 8px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 300px;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .accept-call {
            background-color: #28a745 !important;
        }
        .reject-call {
            background-color: #dc3545 !important;
        }
        .calling-status {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test WebRTC Video Call</h1>
        
        <div class="auth-container">
            <!-- Form đăng nhập -->
            <div class="auth-form" id="loginForm">
                <h2>Đăng nhập</h2>
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button onclick="login()">Đăng nhập</button>
            </div>

            <!-- Form đăng ký -->
            <div class="auth-form" id="registerForm">
                <h2>Đăng ký</h2>
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" required>
                </div>
                <button onclick="register()">Đăng ký</button>
            </div>
        </div>

        <div class="call-section" style="display: none;">
            <div class="status" id="connectionStatus">Chưa kết nối</div>
            
            <div class="video-container">
                <div>
                    <h3>Local Video</h3>
                    <video id="localVideo" autoplay playsinline muted></video>
                </div>
                <div>
                    <h3>Remote Video</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="targetUserId" placeholder="ID người nhận">
                <button onclick="startCall()">Gọi</button>
                <button onclick="endCall()" class="end-call">Kết thúc</button>
                <button onclick="toggleAudio()" id="audioBtn">Tắt mic</button>
                <button onclick="toggleVideo()" id="videoBtn">Tắt camera</button>
                <button onclick="logout()" class="end-call">Đăng xuất</button>
            </div>
        </div>
    </div>

    <div id="incomingCallModal" class="modal">
        <div class="modal-content">
            <h2>Cuộc gọi đến</h2>
            <p id="callerInfo">Đang có cuộc gọi từ: <span id="callerName"></span></p>
            <div class="modal-buttons">
                <button onclick="acceptCall()" class="accept-call">Chấp nhận</button>
                <button onclick="rejectCall()" class="reject-call">Từ chối</button>
            </div>
        </div>
    </div>

    <div id="callingStatus" class="calling-status">
        Đang gọi...
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket;
        let localStream;
        let peerConnection;
        let currentCall = null;
        let currentUser = null;
        let incomingCallData = null;

        // Gọi checkAuth khi trang load
        document.addEventListener('DOMContentLoaded', checkAuth);

        const configuration = {
            iceServers: [
                {
                    urls: [
                        'stun:stun.l.google.com:19302',
                        'stun:stun1.l.google.com:19302'
                    ]
                }
            ]
        };

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message);
                }

                const data = await response.json();
                currentUser = data.user;
                
                // Lưu thông tin vào localStorage
                localStorage.setItem('auth', JSON.stringify({
                    user: data.user,
                    token: data.token,
                    lastLogin: new Date().toISOString()
                }));
                
                // Kết nối WebSocket với token
                connectSocket(data.token);

                // Ẩn form đăng nhập/đăng ký
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.call-section').style.display = 'block';

                updateStatus(`Đã đăng nhập: ${currentUser.username}`);
            } catch (error) {
                alert(error.message || 'Lỗi đăng nhập');
            }
        }

        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message);
                }

                const data = await response.json();
                currentUser = data.user;
                
                // Kết nối WebSocket với token
                connectSocket(data.token);

                // Ẩn form đăng nhập/đăng ký
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.call-section').style.display = 'block';

                updateStatus(`Đã đăng ký và đăng nhập: ${currentUser.username}`);
            } catch (error) {
                alert(error.message || 'Lỗi đăng ký');
            }
        }

        function logout() {
            if (socket) {
                socket.disconnect();
            }
            currentUser = null;
            // Xóa thông tin đăng nhập khỏi localStorage
            localStorage.removeItem('auth');
            cleanup();

            // Hiển thị lại form đăng nhập/đăng ký
            document.querySelector('.auth-container').style.display = 'flex';
            document.querySelector('.call-section').style.display = 'none';

            // Reset các form
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('regUsername').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
        }

        function connectSocket(token) {
            // Kết nối tới WebSocket server với token
            socket = io('http://localhost:62860', {
                query: {
                    token: token
                }
            });

            setupSocketListeners();
            setupLocalStream();
        }

        function setupSocketListeners() {
            socket.on('connect', () => {
                console.log('✅ Socket connected successfully', {
                    socketId: socket.id,
                    userId: currentUser?._id,
                    username: currentUser?.username
                });
                updateStatus('Đã kết nối tới server');
            });

            socket.on('disconnect', () => {
                console.log('❌ Socket disconnected');
                updateStatus('Mất kết nối tới server');
                cleanup();
            });

            socket.on('connect_error', (error) => {
                console.error('❌ Socket connection error:', error);
                updateStatus('Lỗi kết nối: ' + error.message);
            });

            socket.on('incoming_call', async (data) => {
                try {
                    console.log('📞 Incoming call received:', {
                        from: data.from,
                        fromUsername: data.fromUsername,
                        type: data.type,
                        timestamp: new Date().toISOString()
                    });
                    
                    if (!data || !data.from || !data.fromUsername) {
                        throw new Error('Dữ liệu cuộc gọi không hợp lệ');
                    }

                    // Kiểm tra xem có đang trong cuộc gọi khác không
                    if (currentCall) {
                        console.log('❌ Reject call - Already in another call', {
                            currentCall,
                            newCall: data.from
                        });
                        socket.emit('call_response', {
                            targetUserId: data.from,
                            accepted: false,
                            reason: 'busy'
                        });
                        return;
                    }

                    // Yêu cầu quyền thông báo nếu chưa có
                    if (Notification.permission !== 'granted') {
                        await Notification.requestPermission();
                    }

                    // Hiển thị thông báo desktop
                    if (Notification.permission === 'granted') {
                        const notification = new Notification('Cuộc gọi đến', {
                            body: `${data.fromUsername} đang gọi cho bạn`,
                            requireInteraction: true
                        });
                        
                        notification.onclick = function() {
                            window.focus();
                            this.close();
                        };
                    }

                    // Lưu thông tin cuộc gọi đến
                    incomingCallData = data;
                    
                    // Hiển thị modal và phát âm báo
                    showIncomingCall(data);
                    
                    // Tự động từ chối sau 30 giây nếu không phản hồi
                    setTimeout(() => {
                        if (incomingCallData && incomingCallData.from === data.from) {
                            console.log('⏰ Auto rejecting call after timeout', {
                                from: data.from,
                                timestamp: new Date().toISOString()
                            });
                            rejectCall('timeout');
                        }
                    }, 30000);

                } catch (error) {
                    console.error('❌ Error handling incoming call:', error);
                    if (data && data.from) {
                        socket.emit('call_response', {
                            targetUserId: data.from,
                            accepted: false,
                            reason: 'error'
                        });
                    }
                }
            });

            socket.on('call_accepted', async (data) => {
                console.log('✅ Call accepted:', {
                    from: data.from,
                    username: data.username,
                    timestamp: new Date().toISOString()
                });
                hideCallingStatus();
                updateStatus('Cuộc gọi được chấp nhận');
                await setupPeerConnection(data.from, true);
            });

            socket.on('call_rejected', (data) => {
                console.log('❌ Call rejected:', {
                    from: data.from,
                    reason: data.reason,
                    timestamp: new Date().toISOString()
                });
                hideCallingStatus();
                let message = 'Cuộc gọi bị từ chối';
                
                // Thêm lý do từ chối nếu có
                if (data.reason) {
                    switch(data.reason) {
                        case 'busy':
                            message += ': Người dùng đang bận';
                            break;
                        case 'timeout':
                            message += ': Không có phản hồi';
                            break;
                        case 'error':
                            message += ': Lỗi kết nối';
                            break;
                        default:
                            message += ': ' + data.reason;
                    }
                }
                
                updateStatus(message);
                cleanup();
            });

            socket.on('call_error', (error) => {
                console.error('❌ Call error:', error);
                updateStatus('Lỗi cuộc gọi: ' + error.message);
            });

            socket.on('offer', async (data) => {
                try {
                    console.log('📨 Received offer:', {
                        from: data.from,
                        timestamp: new Date().toISOString()
                    });
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    console.log('📤 Sending answer to:', data.from);
                    socket.emit('answer', {
                        answer,
                        targetUserId: data.from
                    });
                } catch (error) {
                    console.error('❌ Error handling offer:', error);
                }
            });

            socket.on('answer', async (data) => {
                try {
                    console.log('📨 Received answer:', {
                        from: data.from,
                        timestamp: new Date().toISOString()
                    });
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                } catch (error) {
                    console.error('❌ Error handling answer:', error);
                }
            });

            socket.on('ice_candidate', async (data) => {
                try {
                    console.log('🧊 Received ICE candidate:', {
                        from: data.from,
                        timestamp: new Date().toISOString()
                    });
                    if (data.candidate) {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    }
                } catch (error) {
                    console.error('❌ Error handling ICE candidate:', error);
                }
            });

            socket.on('call_ended', () => {
                console.log('📞 Call ended');
                hideCallingStatus();
                hideIncomingCall();
                updateStatus('Cuộc gọi kết thúc');
                cleanup();
            });
        }

        async function setupLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (error) {
                console.error('Error accessing media devices:', error);
                updateStatus('Lỗi truy cập camera/mic');
            }
        }

        async function setupPeerConnection(targetUserId, isInitiator) {
            peerConnection = new RTCPeerConnection(configuration);

            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice_candidate', {
                        candidate: event.candidate,
                        targetUserId
                    });
                }
            };

            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            if (isInitiator) {
                try {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('offer', {
                        offer,
                        targetUserId
                    });
                } catch (error) {
                    console.error('Error creating offer:', error);
                }
            }

            currentCall = targetUserId;
        }

        async function startCall() {
            const targetUserId = document.getElementById('targetUserId').value;
            if (!targetUserId) {
                alert('Vui lòng nhập ID người nhận');
                return;
            }

            console.log('📞 Initiating call:', {
                targetUserId,
                type: 'video',
                timestamp: new Date().toISOString()
            });

            showCallingStatus();
            updateStatus('Đang gọi...');
            
            socket.emit('call_user', {
                targetUserId,
                type: 'video'
            });
        }

        function endCall() {
            if (currentCall) {
                socket.emit('end_call', {
                    targetUserId: currentCall
                });
                hideCallingStatus();
                cleanup();
            }
        }

        function cleanup() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            document.getElementById('remoteVideo').srcObject = null;
            currentCall = null;
            hideCallingStatus();
            hideIncomingCall();
            updateStatus(currentUser ? `Đã đăng nhập: ${currentUser.username}` : 'Chưa đăng nhập');
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('audioBtn').textContent = 
                    audioTrack.enabled ? 'Tắt mic' : 'Bật mic';
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('videoBtn').textContent = 
                    videoTrack.enabled ? 'Tắt camera' : 'Bật camera';
            }
        }

        function updateStatus(message) {
            document.getElementById('connectionStatus').textContent = message;
        }

        function showIncomingCall(data) {
            console.log('Incoming call data:', data); // Debug log
            incomingCallData = data;
            const callerName = document.getElementById('callerName');
            callerName.textContent = data.fromUsername || data.from;
            const modal = document.getElementById('incomingCallModal');
            modal.style.display = 'block';
            // Phát âm thanh thông báo
            playRingtone();
        }

        function hideIncomingCall() {
            const modal = document.getElementById('incomingCallModal');
            modal.style.display = 'none';
            incomingCallData = null;
            stopRingtone();
        }

        function showCallingStatus() {
            const status = document.getElementById('callingStatus');
            status.style.display = 'block';
        }

        function hideCallingStatus() {
            const status = document.getElementById('callingStatus');
            status.style.display = 'none';
        }

        async function acceptCall() {
            if (!incomingCallData) return;
            
            console.log('✅ Accepting call from:', {
                from: incomingCallData.from,
                timestamp: new Date().toISOString()
            });
            
            hideIncomingCall();
            updateStatus('Đang kết nối cuộc gọi...');
            
            try {
                await setupLocalStream();
                
                socket.emit('call_response', {
                    targetUserId: incomingCallData.from,
                    accepted: true
                });
                
                await setupPeerConnection(incomingCallData.from, false);
            } catch (error) {
                console.error('❌ Error accepting call:', error);
                updateStatus('Lỗi khi kết nối cuộc gọi');
            }
        }

        function rejectCall(reason) {
            if (!incomingCallData) return;
            
            console.log('❌ Rejecting call:', {
                from: incomingCallData.from,
                reason,
                timestamp: new Date().toISOString()
            });
            
            socket.emit('call_response', {
                targetUserId: incomingCallData.from,
                accepted: false,
                reason: reason
            });
            
            hideIncomingCall();
            updateStatus(`Đã từ chối cuộc gọi. Lý do: ${reason}`);
        }

        // Thêm âm thanh thông báo
        let ringtone;
        function playRingtone() {
            ringtone = new Audio('https://assets.mixkit.co/active_storage/sfx/2912/2912-preview.mp3');
            ringtone.loop = true;
            ringtone.play().catch(e => console.log('Không thể phát nhạc chuông:', e));
        }

        function stopRingtone() {
            if (ringtone) {
                ringtone.pause();
                ringtone.currentTime = 0;
            }
        }

        // Thêm hàm kiểm tra đăng nhập khi load trang
        function checkAuth() {
            const auth = localStorage.getItem('auth');
            if (auth) {
                const { user, token } = JSON.parse(auth);
                currentUser = user;
                connectSocket(token);
                document.querySelector('.auth-container').style.display = 'none';
                document.querySelector('.call-section').style.display = 'block';
                updateStatus(`Đã đăng nhập: ${currentUser.username}`);
            }
        }
    </script>
</body>
</html> 